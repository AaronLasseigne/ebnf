<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>parser.rb</title>
  <link rel="stylesheet" href="docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>parser.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-EBNF_Parser_for_EBNF.'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-EBNF_Parser_for_EBNF.">&#182;</a>
        </div>
        <h1>EBNF Parser for EBNF.</h1>

<p>Produces an Abstract Synatx Tree in S-Expression form for the input grammar file</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;ebnf/rule&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;ebnf/ll1/parser&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;meta&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;terminals&#39;</span>

<span class="k">class</span> <span class="nc">EBNFParser</span>
  <span class="kp">include</span> <span class="ss">EBNF</span><span class="p">:</span><span class="ss">:LL1</span><span class="o">::</span><span class="no">Parser</span>
  <span class="kp">include</span> <span class="no">EBNFParserMeta</span>
  <span class="kp">include</span> <span class="no">EBNFParserTerminals</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>Abstract syntax tree from parse</p>

<p>@return [Array<a href="EBNF::Rule">EBNF::Rule</a>]</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="kp">attr_reader</span> <span class="ss">:ast</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Grammar errors, or errors found genering parse tables</p>

<p>@return [Array<String>]</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="kp">attr_accessor</span> <span class="ss">:errors</span></pre></div>
      </td>
    </tr>
    <tr id='section-Terminals'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Terminals">&#182;</a>
        </div>
        <h2>Terminals</h2>

<p>Define rules for Terminals, placing results on the input stack, making them available to upstream non-Terminal rules.</p>

<p>Terminals are matched in the order of appearance</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>Match the Left hand side of a rule or terminal</p>

<pre><code>[11] LHS        ::= ENUM? SYMBOL &ldquo;::=&rdquo;
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">terminal</span><span class="p">(</span><span class="ss">:LHS</span><span class="p">,</span> <span class="no">LHS</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">prod</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">input</span><span class="o">|</span>
    <span class="n">input</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">,</span> <span class="n">input</span><span class="o">[</span><span class="ss">:symbol</span><span class="o">]</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/\[([^\]]+)\]\s*(\w+)\s*::=/</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>Match <code>SYMBOL</code> terminal</p>

<pre><code>[12] SYMBOL     ::= ([a-z] | [A-Z] | [0-9] | &ldquo;_&rdquo; | &ldquo;.&rdquo;)+
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">terminal</span><span class="p">(</span><span class="ss">:SYMBOL</span><span class="p">,</span> <span class="no">SYMBOL</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">prod</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">input</span><span class="o">|</span>
    <span class="n">input</span><span class="o">[</span><span class="ss">:terminal</span><span class="o">]</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">to_sym</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>Terminal for <code>RANGE</code> is matched as part of a <code>primary</code> rule. Unescape the values to remove EBNF escapes in the input.</p>

<pre><code>[14] RANGE      ::= &lsquo;[&rsquo; CHAR &lsquo;&ndash;&rsquo; CHAR &lsquo;]&rsquo;
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">terminal</span><span class="p">(</span><span class="ss">:RANGE</span><span class="p">,</span> <span class="no">RANGE</span><span class="p">,</span> <span class="ss">:unescape</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">prod</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">input</span><span class="o">|</span>
    <span class="n">input</span><span class="o">[</span><span class="ss">:terminal</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:range</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">2</span><span class="o">]]</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>Terminal for <code>ENUM</code> is matched as part of a <code>primary</code> rule. Unescape the values to remove EBNF escapes in the input.</p>

<pre><code>[15] ENUM       ::= &lsquo;[&rsquo; CHAR+ &lsquo;]&rsquo;
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">terminal</span><span class="p">(</span><span class="ss">:ENUM</span><span class="p">,</span> <span class="no">ENUM</span><span class="p">,</span> <span class="ss">:unescape</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">prod</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">input</span><span class="o">|</span>
    <span class="n">input</span><span class="o">[</span><span class="ss">:terminal</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:range</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">2</span><span class="o">]]</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>Terminal for <code>O_RANGE</code> is matched as part of a <code>primary</code> rule. Unescape the values to remove EBNF escapes in the input.</p>

<pre><code>[16] O_RANGE    ::= &lsquo;[^&rsquo; CHAR &lsquo;&ndash;&rsquo; CHAR &lsquo;]&rsquo;
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">terminal</span><span class="p">(</span><span class="ss">:O_RANGE</span><span class="p">,</span> <span class="no">O_RANGE</span><span class="p">,</span> <span class="ss">:unescape</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">prod</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">input</span><span class="o">|</span>
    <span class="n">input</span><span class="o">[</span><span class="ss">:terminal</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:range</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">2</span><span class="o">]]</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>Terminal for <code>O_ENUM</code> is matched as part of a <code>primary</code> rule. Unescape the values to remove EBNF escapes in the input.</p>

<pre><code>[17] O_ENUM     ::= &lsquo;[^&rsquo; CHAR+ &lsquo;]&rsquo;
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">terminal</span><span class="p">(</span><span class="ss">:O_ENUM</span><span class="p">,</span> <span class="no">O_ENUM</span><span class="p">,</span> <span class="ss">:unescape</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">prod</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">input</span><span class="o">|</span>
    <span class="n">input</span><span class="o">[</span><span class="ss">:terminal</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:range</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">2</span><span class="o">]]</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>Strings have internal escape sequences expanded and are passed through without surrounding quotes as terminals</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>Match double quote string</p>

<pre><code>[18] STRING1    ::= &lsquo;&ldquo;&rsquo; (CHAR | [\t\&lsquo;\[\]\(\)\&ndash;])* &rsquo;&rdquo;&lsquo;
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">terminal</span><span class="p">(</span><span class="ss">:STRING1</span><span class="p">,</span> <span class="no">STRING1</span><span class="p">,</span> <span class="ss">:unescape</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">prod</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">input</span><span class="o">|</span>
    <span class="n">input</span><span class="o">[</span><span class="ss">:terminal</span><span class="o">]</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">2</span><span class="o">]</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>Match single quote string</p>

<pre><code>[19] STRING2    ::= &ldquo;&rsquo;&rdquo; (CHAR | [\t\&ldquo;\[\]\(\)\&ndash;])* &rdquo;&lsquo;&ldquo;
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">terminal</span><span class="p">(</span><span class="ss">:STRING2</span><span class="p">,</span> <span class="no">STRING2</span><span class="p">,</span> <span class="ss">:unescape</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">prod</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">input</span><span class="o">|</span>
    <span class="n">input</span><span class="o">[</span><span class="ss">:terminal</span><span class="o">]</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">2</span><span class="o">]</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>Match <code>POSTFIX</code> terminal</p>

<pre><code>[21] POSTFIX    ::= [?*+]
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">terminal</span><span class="p">(</span><span class="ss">:POSTFIX</span><span class="p">,</span> <span class="no">POSTFIX</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">prod</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">input</span><span class="o">|</span>
    <span class="n">input</span><span class="o">[</span><span class="ss">:postfix</span><span class="o">]</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">value</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>Make sure we recognize string terminals, even though they&rsquo;re not actually used in processing</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">terminal</span><span class="p">(</span><span class="kp">nil</span><span class="p">,</span>                  <span class="sr">%r(@terminals|@pass|[\[\]|\-\(\)])</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-Non-terminal_productions'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Non-terminal_productions">&#182;</a>
        </div>
        <h2>Non-terminal productions</h2>

<p>Define productions for non-Termainals. This can include <code>start_production</code> as well as <code>production</code> to hook into rule start and end. In some cases, we need to use sub-productions as generated when turning EBNF into BNF.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>Production for end of <code>rule</code> non-terminal.
The <code>input</code> parameter includes information placed by previous productions at the same level, or at the start of the current production.
The <code>current</code> parameter, is the result of child productions placing information onto their input.
The <code>callback</code> parameter provides access to a callback defined in the call to <code>parse</code>, see <code>#each_rule</code> below).</p>

<p>Create rule from expression value and pass to callback</p>

<pre><code>[3] rule        ::= LHS expression
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">production</span><span class="p">(</span><span class="ss">:rule</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">input</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">callback</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>current contains a declaration.
Invoke callback</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">callback</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="ss">:rule</span><span class="p">,</span> <span class="ss">EBNF</span><span class="p">:</span><span class="ss">:Rule</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">current</span><span class="o">[</span><span class="ss">:symbol</span><span class="o">].</span><span class="n">to_sym</span><span class="p">,</span> <span class="n">current</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">,</span> <span class="n">current</span><span class="o">[</span><span class="ss">:expression</span><span class="o">].</span><span class="n">last</span><span class="p">))</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>Production for end of <code>expression</code> non-terminal.
Passes through the optimized value of the alt production as follows:</p>

<pre><code>[:alt foo] =&gt; foo
[:alt foo bar] =&gt; [:alt foo bar]

[4] expression  ::= alt
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">production</span><span class="p">(</span><span class="ss">:expression</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">input</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">callback</span><span class="o">|</span>
    <span class="n">alt</span> <span class="o">=</span> <span class="n">current</span><span class="o">[</span><span class="ss">:alt</span><span class="o">]</span>
    <span class="p">(</span><span class="n">input</span><span class="o">[</span><span class="ss">:expression</span><span class="o">]</span> <span class="o">||=</span> <span class="o">[</span><span class="ss">:expression</span><span class="o">]</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">?</span> <span class="n">alt</span> <span class="p">:</span> <span class="n">alt</span><span class="o">.</span><span class="n">last</span><span class="p">)</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>Production for end of <code>alt</code> non-terminal.
Passes through the optimized value of the seq production as follows:</p>

<pre><code>[:seq foo] =&gt; foo
[:seq foo bar] =&gt; [:seq foo bar]
</code></pre>

<p>Note that this also may just pass through from <code>_alt_1</code></p>

<pre><code>[5] alt         ::= seq (&rsquo;|&lsquo; seq)*
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">production</span><span class="p">(</span><span class="ss">:alt</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">input</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">callback</span><span class="o">|</span>
    <span class="n">input</span><span class="o">[</span><span class="ss">:alt</span><span class="o">]</span> <span class="o">=</span> <span class="k">if</span> <span class="n">current</span><span class="o">[</span><span class="ss">:alt</span><span class="o">]</span>
      <span class="n">current</span><span class="o">[</span><span class="ss">:alt</span><span class="o">]</span>
    <span class="k">elsif</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">current</span><span class="o">[</span><span class="ss">:seq</span><span class="o">]</span>
      <span class="o">[</span><span class="ss">:alt</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">?</span> <span class="n">seq</span> <span class="p">:</span> <span class="n">seq</span><span class="o">.</span><span class="n">last</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>Because <code>alt</code> can refer to <code>seq</code> multiple times, we need to separate information from each sequence. To do this, we intercept the start of <code>_alt_1</code> to reset the <code>:seq</code> input and record the existing optimized <code>seq</code> value</p>

<p>The generated sub-productions for <code>_alt_1</code> are:</p>

<pre><code>(rule _alt_1 &quot;5.1&rdquo;
 (first _eps &ldquo;|&rdquo;)
 (follow &ldquo;)&rdquo; &ldquo;@pass&rdquo; &ldquo;@terminals&rdquo; LHS _eof)
 (alt _empty _alt_3))
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">start_production</span><span class="p">(</span><span class="ss">:_alt_1</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">input</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">callback</span><span class="o">|</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">(</span><span class="n">input</span><span class="o">[</span><span class="ss">:seq</span><span class="o">]</span><span class="p">)</span>
    <span class="p">(</span><span class="n">input</span><span class="o">[</span><span class="ss">:alt</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:alt</span><span class="o">]</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">?</span> <span class="n">seq</span> <span class="p">:</span> <span class="n">seq</span><span class="o">.</span><span class="n">last</span><span class="p">)</span>
    <span class="n">input</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:seq</span><span class="p">)</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <p>After <code>_alt_1</code> sub-production, add any optimized seq value and append recursive alt calls</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">production</span><span class="p">(</span><span class="ss">:_alt_1</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">input</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">callback</span><span class="o">|</span>
    <span class="n">input</span><span class="o">[</span><span class="ss">:alt</span><span class="o">]</span> <span class="o">||=</span> <span class="o">[</span><span class="ss">:alt</span><span class="o">]</span></pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <p>Add optimized value of <code>seq,</code> if any</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">current</span><span class="o">[</span><span class="ss">:seq</span><span class="o">]</span>
      <span class="n">input</span><span class="o">[</span><span class="ss">:alt</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="n">seq</span><span class="o">.</span><span class="n">last</span> <span class="p">:</span> <span class="n">seq</span><span class="p">)</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-24'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-24">&#182;</a>
        </div>
        <p>Also recursive call to <code>_alt_1</code></p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">input</span><span class="o">[</span><span class="ss">:alt</span><span class="o">]</span> <span class="o">+=</span> <span class="n">current</span><span class="o">[</span><span class="ss">:alt</span><span class="o">][</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span> <span class="k">if</span> <span class="n">current</span><span class="o">[</span><span class="ss">:alt</span><span class="o">]</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-25">&#182;</a>
        </div>
        <p>Production for end of <code>seq</code> non-terminal.
Passes through the optimized value of the <code>diff</code> production as follows:</p>

<pre><code>[:diff foo] =&gt; foo
[:diff foo bar] =&gt; [:diff foo bar]
</code></pre>

<p>Note that this also may just pass through from <code>_seq_1</code></p>

<pre><code>[6] seq         ::= diff+
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">production</span><span class="p">(</span><span class="ss">:seq</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">input</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">callback</span><span class="o">|</span>
    <span class="n">input</span><span class="o">[</span><span class="ss">:seq</span><span class="o">]</span> <span class="o">=</span> <span class="k">if</span> <span class="n">current</span><span class="o">[</span><span class="ss">:seq</span><span class="o">]</span>
      <span class="n">current</span><span class="o">[</span><span class="ss">:seq</span><span class="o">]</span>
    <span class="k">elsif</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">current</span><span class="o">[</span><span class="ss">:diff</span><span class="o">]</span>
      <span class="o">[</span><span class="ss">:seq</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">?</span> <span class="n">diff</span> <span class="p">:</span> <span class="n">diff</span><span class="o">.</span><span class="n">last</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>Because <code>seq</code> can refer to <code>diff</code>multiple times, we need to separate information from each sequence. To do this, we intercept the start of <code>_seq_1</code> to reset the <code>:diff</code> input and record the existing optimized <code>seq</code> value</p>

<p>The generated sub-productions for <code>_seq_1</code> are:</p>

<pre><code>(rule _seq_1 &ldquo;6.1&rdquo;
 (first &ldquo;(&rdquo; ENUM HEX O_ENUM O_RANGE RANGE STRING1 STRING2 SYMBOL _eps)
 (follow &ldquo;)&rdquo; &ldquo;@pass&rdquo; &ldquo;@terminals&rdquo; LHS _eof &ldquo;|&rdquo;)
 (alt _empty _seq_2))
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">start_production</span><span class="p">(</span><span class="ss">:_seq_1</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">input</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">callback</span><span class="o">|</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">(</span><span class="n">input</span><span class="o">[</span><span class="ss">:diff</span><span class="o">]</span><span class="p">)</span>
    <span class="p">(</span><span class="n">input</span><span class="o">[</span><span class="ss">:seq</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:seq</span><span class="o">]</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">?</span> <span class="n">diff</span> <span class="p">:</span> <span class="n">diff</span><span class="o">.</span><span class="n">last</span><span class="p">)</span>
    <span class="n">input</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:diff</span><span class="p">)</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-27">&#182;</a>
        </div>
        <p>After <code>_seq_1</code> sub-production, add any optimized <code>diff</code> value and append recursive <code>seq</code> calls</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">production</span><span class="p">(</span><span class="ss">:_seq_1</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">input</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">callback</span><span class="o">|</span>
    <span class="n">input</span><span class="o">[</span><span class="ss">:seq</span><span class="o">]</span> <span class="o">||=</span> <span class="o">[</span><span class="ss">:seq</span><span class="o">]</span></pre></div>
      </td>
    </tr>
    <tr id='section-28'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-28">&#182;</a>
        </div>
        <p>Add optimized value of <code>diff</code>, if any</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">current</span><span class="o">[</span><span class="ss">:diff</span><span class="o">]</span>
      <span class="n">input</span><span class="o">[</span><span class="ss">:seq</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">?</span> <span class="n">diff</span> <span class="p">:</span> <span class="n">diff</span><span class="o">.</span><span class="n">last</span><span class="p">)</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-29'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-29">&#182;</a>
        </div>
        <p>Also recursive call to <code>_seq_1</code></p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">input</span><span class="o">[</span><span class="ss">:seq</span><span class="o">]</span> <span class="o">+=</span> <span class="n">current</span><span class="o">[</span><span class="ss">:seq</span><span class="o">][</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span> <span class="k">if</span> <span class="n">current</span><span class="o">[</span><span class="ss">:seq</span><span class="o">]</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-30'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-30">&#182;</a>
        </div>
        <p><code>Diff</code> production returns concatenated postfix values</p>

<pre><code>[7] diff        ::= postfix (&rsquo;&ndash;&lsquo; postfix)?
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">production</span><span class="p">(</span><span class="ss">:diff</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">input</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">callback</span><span class="o">|</span>
    <span class="p">(</span><span class="n">input</span><span class="o">[</span><span class="ss">:diff</span><span class="o">]</span> <span class="o">||=</span> <span class="o">[</span><span class="ss">:diff</span><span class="o">]</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">current</span><span class="o">[</span><span class="ss">:postfix</span><span class="o">]</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-31'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-31">&#182;</a>
        </div>
        <p>Production for end of <code>postfix</code> non-terminal.
Either returns the <code>primary</code> production value, or as modified by the <code>postfix</code>.</p>

<pre><code>[8] postfix     ::= primary POSTFIX?
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">production</span><span class="p">(</span><span class="ss">:postfix</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">input</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">callback</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-32'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-32">&#182;</a>
        </div>
        <p>Push result onto input stack, as the <code>diff</code> production can have some number of <code>postfix</code> values that are applied recursively</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">input</span><span class="o">[</span><span class="ss">:postfix</span><span class="o">]</span> <span class="o">=</span>  <span class="k">case</span> <span class="n">current</span><span class="o">[</span><span class="ss">:postfix</span><span class="o">]</span>
    <span class="k">when</span> <span class="s2">&quot;*&quot;</span> <span class="k">then</span> <span class="o">[</span><span class="ss">:star</span><span class="p">,</span> <span class="n">current</span><span class="o">[</span><span class="ss">:primary</span><span class="o">]]</span>
    <span class="k">when</span> <span class="s2">&quot;+&quot;</span> <span class="k">then</span> <span class="o">[</span><span class="ss">:plus</span><span class="p">,</span> <span class="n">current</span><span class="o">[</span><span class="ss">:primary</span><span class="o">]]</span>
    <span class="k">when</span> <span class="s2">&quot;?&quot;</span> <span class="k">then</span> <span class="o">[</span><span class="ss">:opt</span><span class="p">,</span> <span class="n">current</span><span class="o">[</span><span class="ss">:primary</span><span class="o">]]</span>
    <span class="k">else</span> <span class="n">current</span><span class="o">[</span><span class="ss">:primary</span><span class="o">]</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-33'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-33">&#182;</a>
        </div>
        <p>Production for end of <code>primary</code> non-terminal.
Places <code>:primary</code> on the stack</p>

<p>This may either be a terminal, or the result of an <code>expression</code>.</p>

<pre><code>[9] primary     ::= HEX
                |   SYMBOL
                |   RANGE
                |   ENUM
                |   O_RANGE
                |   O_ENUM
                |   STRING1
                |   STRING2
                |   &rsquo;(&lsquo; expression &rsquo;)&lsquo;
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">production</span><span class="p">(</span><span class="ss">:primary</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">input</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">callback</span><span class="o">|</span>
    <span class="n">input</span><span class="o">[</span><span class="ss">:primary</span><span class="o">]</span> <span class="o">=</span> <span class="k">if</span> <span class="n">current</span><span class="o">[</span><span class="ss">:expression</span><span class="o">]</span>
      <span class="n">v</span> <span class="o">=</span> <span class="n">current</span><span class="o">[</span><span class="ss">:expression</span><span class="o">][</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
      <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">first</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">else</span>
      <span class="n">current</span><span class="o">[</span><span class="ss">:terminal</span><span class="o">]</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-34'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-34">&#182;</a>
        </div>
        <p>Production for end of pass non-terminal.</p>

<pre><code>[10] pass       ::= &rsquo;@pass' expression
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">production</span><span class="p">(</span><span class="ss">:pass</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">input</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">callback</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-35'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-35">&#182;</a>
        </div>
        <p>Invoke callback</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">callback</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="ss">:pass</span><span class="p">,</span> <span class="n">current</span><span class="o">[</span><span class="ss">:expression</span><span class="o">].</span><span class="n">last</span><span class="p">)</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-Parser_invocation.'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Parser_invocation.">&#182;</a>
        </div>
        <h2>Parser invocation.</h2>

<p>On start, yield ourselves if a block is given, otherwise, return this parser instance</p>

<p>@param  [#read, #to_s]          input
@param  [Hash{Symbol =&gt; Object}] options
@option options [Hash]     :prefixes     (Hash.new)
  the prefix mappings to use (for acessing intermediate parser productions)
@option options [Boolean] :progress
  Show progress of parser productions
@return [EBNFParser]</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="vi">@options</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">dup</span>
    <span class="vi">@input</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:read</span><span class="p">)</span> <span class="p">?</span> <span class="n">input</span><span class="o">.</span><span class="n">read</span> <span class="p">:</span> <span class="n">input</span><span class="o">.</span><span class="n">to_s</span>

    <span class="n">parsing_terminals</span> <span class="o">=</span> <span class="kp">false</span>
    <span class="vi">@ast</span> <span class="o">=</span> <span class="o">[]</span>
    <span class="n">parse</span><span class="p">(</span><span class="vi">@input</span><span class="p">,</span> <span class="no">START</span><span class="o">.</span><span class="n">to_sym</span><span class="p">,</span> <span class="vi">@options</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:branch</span> <span class="o">=&gt;</span> <span class="no">BRANCH</span><span class="p">,</span>
                                               <span class="ss">:first</span> <span class="o">=&gt;</span> <span class="no">FIRST</span><span class="p">,</span>
                                               <span class="ss">:follow</span> <span class="o">=&gt;</span> <span class="no">FOLLOW</span><span class="p">,</span>
                                               <span class="ss">:whitespace</span> <span class="o">=&gt;</span> <span class="ss">EBNFParserTerminals</span><span class="p">:</span><span class="ss">:PASS</span><span class="p">,</span>
                                               <span class="ss">:reset_on_start</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
    <span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">context</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="o">|</span>
      <span class="n">rule</span> <span class="o">=</span> <span class="k">case</span> <span class="n">context</span>
      <span class="k">when</span> <span class="ss">:terminal</span>
        <span class="n">parsing_terminals</span> <span class="o">=</span> <span class="kp">true</span>
        <span class="k">next</span>
      <span class="k">when</span> <span class="ss">:pass</span>
        <span class="n">rule</span> <span class="o">=</span> <span class="ss">EBNF</span><span class="p">:</span><span class="ss">:Rule</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">first</span><span class="p">,</span> <span class="ss">:kind</span> <span class="o">=&gt;</span> <span class="ss">:pass</span><span class="p">)</span>
      <span class="k">when</span> <span class="ss">:rule</span>
        <span class="n">rule</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">first</span>
        <span class="n">rule</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="ss">:terminal</span> <span class="k">if</span> <span class="n">parsing_terminals</span>
        <span class="n">rule</span>
      <span class="k">when</span> <span class="ss">:trace</span>
        <span class="n">level</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">args</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;: &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">d_str</span> <span class="o">=</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="o">?</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span> <span class="p">:</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">depth</span>
        <span class="vg">$stderr</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;[</span><span class="si">#{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">](</span><span class="si">#{</span><span class="n">level</span><span class="si">}</span><span class="s2">)</span><span class="si">#{</span><span class="n">d_str</span><span class="si">}#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">next</span>
      <span class="k">end</span>
      <span class="vi">@ast</span> <span class="o">&lt;&lt;</span> <span class="n">rule</span>
    <span class="k">end</span>
    <span class="vi">@ast</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-37'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-37">&#182;</a>
        </div>
        <p>Output formatted S-Expression of grammar</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">to_sxp</span></pre></div>
      </td>
    </tr>
    <tr id='section-38'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-38">&#182;</a>
        </div>
        <p>Output rules as a formatted S-Expression</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="ss">SXP</span><span class="p">:</span><span class="ss">:Generator</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="vi">@ast</span><span class="o">.</span><span class="n">sort_by</span><span class="p">{</span><span class="o">|</span><span class="n">r</span><span class="o">|</span> <span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">to_f</span><span class="p">}</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:for_sxp</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
